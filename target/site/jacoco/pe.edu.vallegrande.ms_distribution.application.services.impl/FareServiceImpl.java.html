<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="es"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>FareServiceImpl.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">structure-microservice</a> &gt; <a href="index.source.html" class="el_package">pe.edu.vallegrande.ms_distribution.application.services.impl</a> &gt; <span class="el_source">FareServiceImpl.java</span></div><h1>FareServiceImpl.java</h1><pre class="source lang-java linenums">package pe.edu.vallegrande.ms_distribution.application.services.impl;

import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.http.HttpStatus;
import org.springframework.stereotype.Service;
import pe.edu.vallegrande.ms_distribution.application.services.FareService;
import pe.edu.vallegrande.ms_distribution.domain.enums.Constants;
import pe.edu.vallegrande.ms_distribution.domain.models.Fare;
import pe.edu.vallegrande.ms_distribution.infrastructure.dto.request.FareCreateRequest;
import pe.edu.vallegrande.ms_distribution.infrastructure.dto.request.FareUpdateRequest;
import pe.edu.vallegrande.ms_distribution.infrastructure.dto.response.FareResponse;
import pe.edu.vallegrande.ms_distribution.infrastructure.exception.CustomException;
import pe.edu.vallegrande.ms_distribution.infrastructure.repository.FareRepository;
import reactor.core.publisher.Flux;
import reactor.core.publisher.Mono;

import java.time.Instant;
import java.math.BigDecimal;
import java.util.Objects;

@Service
<span class="fc" id="L23">@Slf4j</span>
@RequiredArgsConstructor
public class FareServiceImpl implements FareService {

    private final FareRepository fareRepository;
    private static final String FARE_PREFIX = &quot;TAR&quot;;
    private static final String INITIAL_FARE_CODE = FARE_PREFIX + &quot;001&quot;;

    @Override
    public Flux&lt;Fare&gt; getAllF() {
<span class="fc" id="L33">        return fareRepository.findAll()</span>
<span class="fc" id="L34">                .doOnNext(f -&gt; log.debug(&quot;Fare retrieved: {}&quot;, f))</span>
<span class="fc" id="L35">                .doOnError(error -&gt; log.error(&quot;Error retrieving all fares: {}&quot;, error.getMessage()));</span>
    }

    @Override
    public Flux&lt;Fare&gt; getAllActiveF() {
<span class="fc" id="L40">        return fareRepository.findAllByStatus(Constants.ACTIVE.name())</span>
<span class="fc" id="L41">                .doOnError(error -&gt; log.error(&quot;Error retrieving active fares: {}&quot;, error.getMessage()));</span>
    }

    @Override
    public Flux&lt;Fare&gt; getAllInactiveF() {
<span class="fc" id="L46">        return fareRepository.findAllByStatus(Constants.INACTIVE.name())</span>
<span class="fc" id="L47">                .doOnError(error -&gt; log.error(&quot;Error retrieving inactive fares: {}&quot;, error.getMessage()));</span>
    }

    @Override
    public Mono&lt;Fare&gt; getByIdFMono(String id) {
<span class="fc" id="L52">        validateId(id);</span>
<span class="fc" id="L53">        return fareRepository.findById(id)</span>
<span class="fc" id="L54">                .switchIfEmpty(Mono.error(createFareNotFoundError(id)))</span>
<span class="fc" id="L55">                .doOnSuccess(fare -&gt; log.debug(&quot;Fare found with id: {}&quot;, id))</span>
<span class="fc" id="L56">                .doOnError(error -&gt; log.error(&quot;Error finding fare with id {}: {}&quot;, id, error.getMessage()));</span>
    }

    @Override
    public Mono&lt;FareResponse&gt; saveF(FareCreateRequest request) {
<span class="fc" id="L61">        validateCreateRequest(request);</span>
        
<span class="fc" id="L63">        return generateNextFareCode()</span>
<span class="fc" id="L64">                .flatMap(code -&gt; validateFareCodeNotExists(code)</span>
<span class="fc" id="L65">                        .then(createAndSaveFare(request, code)))</span>
<span class="fc" id="L66">                .doOnSuccess(response -&gt; log.info(&quot;Fare created successfully with code: {}&quot;, response.getFareCode()))</span>
<span class="fc" id="L67">                .doOnError(error -&gt; log.error(&quot;Error creating fare: {}&quot;, error.getMessage()));</span>
    }

    private Mono&lt;String&gt; generateNextFareCode() {
<span class="fc" id="L71">        return fareRepository.findTopByOrderByFareCodeDesc()</span>
<span class="fc" id="L72">                .map(this::extractNextCodeFromLastFare)</span>
<span class="fc" id="L73">                .defaultIfEmpty(INITIAL_FARE_CODE)</span>
<span class="fc" id="L74">                .doOnNext(code -&gt; log.debug(&quot;Generated fare code: {}&quot;, code));</span>
    }

    private String extractNextCodeFromLastFare(Fare lastFare) {
        try {
<span class="fc" id="L79">            String lastCode = lastFare.getFareCode();</span>
<span class="fc bfc" id="L80" title="All 4 branches covered.">            if (lastCode == null || !lastCode.startsWith(FARE_PREFIX)) {</span>
<span class="fc" id="L81">                log.warn(&quot;Invalid fare code format: {}, using default&quot;, lastCode);</span>
<span class="fc" id="L82">                return INITIAL_FARE_CODE;</span>
            }
            
<span class="fc" id="L85">            String numericPart = lastCode.replace(FARE_PREFIX, &quot;&quot;);</span>
<span class="fc" id="L86">            int number = parseNumericCode(numericPart);</span>
<span class="fc" id="L87">            return String.format(FARE_PREFIX + &quot;%03d&quot;, number + 1);</span>
<span class="fc" id="L88">        } catch (Exception e) {</span>
<span class="fc" id="L89">            log.warn(&quot;Error extracting code from last fare, using default: {}&quot;, e.getMessage());</span>
<span class="fc" id="L90">            return INITIAL_FARE_CODE;</span>
        }
    }

    private int parseNumericCode(String numericPart) {
<span class="fc bfc" id="L95" title="All 4 branches covered.">        if (numericPart == null || numericPart.trim().isEmpty()) {</span>
<span class="fc" id="L96">            return 0;</span>
        }
        
<span class="fc bfc" id="L99" title="All 2 branches covered.">        if (!numericPart.matches(&quot;\\d+&quot;)) {</span>
<span class="fc" id="L100">            log.warn(&quot;Invalid numeric code format: {}, using 0&quot;, numericPart);</span>
<span class="fc" id="L101">            return 0;</span>
        }
        
        try {
<span class="fc" id="L105">            return Integer.parseInt(numericPart);</span>
<span class="fc" id="L106">        } catch (NumberFormatException e) {</span>
<span class="fc" id="L107">            log.warn(&quot;Cannot parse numeric code: {}, using 0&quot;, numericPart);</span>
<span class="fc" id="L108">            return 0;</span>
        }
    }

    private Mono&lt;Void&gt; validateFareCodeNotExists(String fareCode) {
<span class="fc" id="L113">        return fareRepository.existsByFareCode(fareCode)</span>
<span class="fc" id="L114">                .flatMap(exists -&gt; {</span>
<span class="fc bfc" id="L115" title="All 2 branches covered.">                    if (exists) {</span>
<span class="fc" id="L116">                        log.warn(&quot;Attempt to create fare with existing code: {}&quot;, fareCode);</span>
<span class="fc" id="L117">                        return Mono.error(createFareCodeExistsError(fareCode));</span>
                    }
<span class="fc" id="L119">                    return Mono.empty();</span>
                });
    }

    private Mono&lt;FareResponse&gt; createAndSaveFare(FareCreateRequest request, String fareCode) {
<span class="fc" id="L124">        Fare fare = buildFareFromRequest(request, fareCode);</span>
<span class="fc" id="L125">        return fareRepository.save(fare)</span>
<span class="fc" id="L126">                .map(this::mapToFareResponse)</span>
<span class="fc" id="L127">                .doOnSuccess(response -&gt; log.debug(&quot;Fare saved with id: {}&quot;, response.getId()));</span>
    }

    private Fare buildFareFromRequest(FareCreateRequest request, String fareCode) {
<span class="fc" id="L131">        return Fare.builder()</span>
<span class="fc" id="L132">                .organizationId(request.getOrganizationId())</span>
<span class="fc" id="L133">                .fareCode(fareCode)</span>
<span class="fc" id="L134">                .fareName(request.getFareName())</span>
<span class="fc" id="L135">                .fareType(request.getFareType())</span>
<span class="fc" id="L136">                .fareAmount(request.getFareAmount())</span>
<span class="fc" id="L137">                .status(Constants.ACTIVE.name())</span>
<span class="fc" id="L138">                .createdAt(Instant.now())</span>
<span class="fc" id="L139">                .build();</span>
    }

    private FareResponse mapToFareResponse(Fare fare) {
<span class="fc" id="L143">        return FareResponse.builder()</span>
<span class="fc" id="L144">                .id(fare.getId())</span>
<span class="fc" id="L145">                .organizationId(fare.getOrganizationId())</span>
<span class="fc" id="L146">                .fareCode(fare.getFareCode())</span>
<span class="fc" id="L147">                .fareName(fare.getFareName())</span>
<span class="fc" id="L148">                .fareType(fare.getFareType())</span>
<span class="fc" id="L149">                .fareAmount(fare.getFareAmount())</span>
<span class="fc" id="L150">                .status(fare.getStatus())</span>
<span class="fc" id="L151">                .createdAt(fare.getCreatedAt())</span>
<span class="fc" id="L152">                .build();</span>
    }

    @Override
    public Mono&lt;Fare&gt; updateF(String id, FareUpdateRequest request) {
<span class="fc" id="L157">        validateId(id);</span>
<span class="fc" id="L158">        validateUpdateRequest(request);</span>
        
<span class="fc" id="L160">        return fareRepository.findById(id)</span>
<span class="fc" id="L161">                .switchIfEmpty(Mono.error(createFareNotFoundError(id)))</span>
<span class="fc" id="L162">                .flatMap(existing -&gt; updateFareFields(existing, request))</span>
<span class="fc" id="L163">                .flatMap(fareRepository::save)</span>
<span class="fc" id="L164">                .doOnSuccess(updated -&gt; log.info(&quot;Fare updated successfully: {}&quot;, id))</span>
<span class="pc" id="L165">                .doOnError(error -&gt; log.error(&quot;Error updating fare {}: {}&quot;, id, error.getMessage()));</span>
    }

    private Mono&lt;Fare&gt; updateFareFields(Fare existing, FareUpdateRequest request) {
<span class="fc bfc" id="L169" title="All 2 branches covered.">        if (request.getFareCode() != null) {</span>
<span class="fc" id="L170">            existing.setFareCode(request.getFareCode());</span>
        }
<span class="fc bfc" id="L172" title="All 2 branches covered.">        if (request.getPrice() != null) {</span>
<span class="fc" id="L173">            existing.setFareAmount(BigDecimal.valueOf(request.getPrice()));</span>
        }
        // request.getDescription() is ignored because Fare model has no description field
<span class="fc" id="L176">        return Mono.just(existing);</span>
    }

    @Override
    public Mono&lt;Void&gt; deleteF(String id) {
<span class="fc" id="L181">        validateId(id);</span>
        
<span class="fc" id="L183">        return fareRepository.findById(id)</span>
<span class="fc" id="L184">                .switchIfEmpty(Mono.error(createFareNotFoundError(id, &quot;Cannot delete non-existent fare&quot;)))</span>
<span class="fc" id="L185">                .flatMap(fare -&gt; {</span>
<span class="fc" id="L186">                    log.info(&quot;Deleting fare: {}&quot;, id);</span>
<span class="fc" id="L187">                    return fareRepository.delete(fare);</span>
                })
<span class="fc" id="L189">                .doOnSuccess(v -&gt; log.info(&quot;Fare deleted successfully: {}&quot;, id))</span>
<span class="fc" id="L190">                .doOnError(error -&gt; log.error(&quot;Error deleting fare {}: {}&quot;, id, error.getMessage()));</span>
    }

    @Override
    public Mono&lt;Fare&gt; activateF(String id) {
<span class="fc" id="L195">        return changeStatus(id, Constants.ACTIVE.name());</span>
    }

    @Override
    public Mono&lt;Fare&gt; deactivateF(String id) {
<span class="fc" id="L200">        return changeStatus(id, Constants.INACTIVE.name());</span>
    }

    private Mono&lt;Fare&gt; changeStatus(String id, String newStatus) {
<span class="fc" id="L204">        validateId(id);</span>
        
<span class="fc" id="L206">        return fareRepository.findById(id)</span>
<span class="fc" id="L207">                .switchIfEmpty(Mono.error(CustomException.notFound(&quot;Fare&quot;, id)))</span>
<span class="fc" id="L208">                .flatMap(fare -&gt; {</span>
<span class="fc" id="L209">                    String oldStatus = fare.getStatus();</span>
<span class="fc bfc" id="L210" title="All 2 branches covered.">                    if (Objects.equals(oldStatus, newStatus)) {</span>
<span class="fc" id="L211">                        log.debug(&quot;Fare {} already has status {}&quot;, id, newStatus);</span>
<span class="fc" id="L212">                        return Mono.just(fare);</span>
                    }
                    
<span class="fc" id="L215">                    fare.setStatus(newStatus);</span>
<span class="fc" id="L216">                    log.info(&quot;Changing fare {} status from {} to {}&quot;, id, oldStatus, newStatus);</span>
                    
<span class="fc" id="L218">                    return fareRepository.save(fare)</span>
<span class="fc" id="L219">                            .doOnSuccess(saved -&gt; log.debug(&quot;Status change saved for fare: {}&quot;, id));</span>
                })
<span class="fc" id="L221">                .doOnError(error -&gt; log.error(&quot;Error changing status for fare {}: {}&quot;, id, error.getMessage()));</span>
    }

    // Métodos de validación privados
    private void validateId(String id) {
<span class="fc bfc" id="L226" title="All 4 branches covered.">        if (id == null || id.trim().isEmpty()) {</span>
<span class="fc" id="L227">            throw new IllegalArgumentException(&quot;Fare ID cannot be null or empty&quot;);</span>
        }
<span class="fc" id="L229">    }</span>

    private void validateCreateRequest(FareCreateRequest request) {
<span class="fc bfc" id="L232" title="All 2 branches covered.">        if (request == null) {</span>
<span class="fc" id="L233">            throw new IllegalArgumentException(&quot;FareCreateRequest cannot be null&quot;);</span>
        }
<span class="fc bfc" id="L235" title="All 4 branches covered.">        if (request.getOrganizationId() == null || request.getOrganizationId().trim().isEmpty()) {</span>
<span class="fc" id="L236">            throw new IllegalArgumentException(&quot;Organization ID is required&quot;);</span>
        }
<span class="fc bfc" id="L238" title="All 4 branches covered.">        if (request.getFareName() == null || request.getFareName().trim().isEmpty()) {</span>
<span class="fc" id="L239">            throw new IllegalArgumentException(&quot;Fare name is required&quot;);</span>
        }
<span class="fc bfc" id="L241" title="All 4 branches covered.">        if (request.getFareAmount() == null || request.getFareAmount().compareTo(java.math.BigDecimal.ZERO) &lt;= 0) {</span>
<span class="fc" id="L242">            throw new IllegalArgumentException(&quot;Fare amount must be greater than zero&quot;);</span>
        }
<span class="fc" id="L244">    }</span>

    private void validateUpdateRequest(FareUpdateRequest request) {
<span class="fc bfc" id="L247" title="All 2 branches covered.">        if (request == null) {</span>
<span class="fc" id="L248">            throw new IllegalArgumentException(&quot;FareUpdateRequest cannot be null&quot;);</span>
        }
<span class="fc" id="L250">    }</span>

    // Métodos de creación de errores privados
    private CustomException createFareNotFoundError(String id) {
<span class="fc" id="L254">        return new CustomException(</span>
<span class="fc" id="L255">                HttpStatus.NOT_FOUND.value(),</span>
                &quot;Fare not found&quot;,
                &quot;The requested fare with id &quot; + id + &quot; was not found&quot;
        );
    }

    private CustomException createFareNotFoundError(String id, String action) {
<span class="fc" id="L262">        return new CustomException(</span>
<span class="fc" id="L263">                HttpStatus.NOT_FOUND.value(),</span>
                &quot;Fare not found&quot;,
                action + &quot; with id &quot; + id
        );
    }

    private CustomException createFareCodeExistsError(String fareCode) {
<span class="fc" id="L270">        return new CustomException(</span>
<span class="fc" id="L271">                HttpStatus.BAD_REQUEST.value(),</span>
                &quot;Fare code already exists&quot;,
                &quot;The fare code &quot; + fareCode + &quot; is already registered&quot;
        );
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.11.202310140853</span></div></body></html>